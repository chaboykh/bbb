// 1. á€á¶ášá áŸ…á™á€ Dependencies (Import Dependencies)
const express = require('express');
const axios = require('axios');
const multer = require('multer'); // á”á“áŸ’ááŸ‚á˜ multer áŸá˜áŸ’ášá¶á”áŸ‹ file uploads
const app = express();
const port = process.env.PORT || 3000; // Use Vercel's port if available

// Multer setup (á”áŸ’ášá¾ memory storage á–áŸ’ášáŸ„áŸ‡ Vercel á˜á·á“á˜á¶á“ persistent file system)
const upload = multer({ storage: multer.memoryStorage() });

// Middleware for parsing form data
app.use(express.urlencoded({ extended: true }));


// !!! áŸáŸ†áá¶á“áŸ‹ !!! áŸá¼á˜áŠá¶á€áŸ‹ Discord Webhook URL ášá”áŸáŸ‹á¢áŸ’á“á€á“áŸ…á‘á¸á“áŸáŸ‡
// !!! IMPORTANT !!! Please put your Discord Webhook URL here
const DISCORD_WEBHOOK_URL = 'YOUR_DISCORD_WEBHOOK_URL_HERE';


// 2. á‘á·á“áŸ’á“á“áŸá™á•á›á·áá•á›á‚áŸ†ášá¼ (Sample Product Data)
const products = [
    {
        id: 1,
        name: 'á€áŸ’ášá˜á¶ááŸ’á˜áŸ‚ášá”áŸ’ášá–áŸƒáá¸',
        price: 20000,
        description: 'á€áŸ’ášá˜á¶â€‹ááŸ’á”á¶á‰â€‹á–á¸â€‹á€á”áŸ’á”á¶áŸâ€‹áŸá»á‘áŸ’á’â€‹ áŸ¡áŸ áŸ % á˜á¶á“â€‹á‚á»áá—á¶á–â€‹á›áŸ’á¢ á“á·á„â€‹á‡á¶â€‹á¢ááŸ’ááŸá‰áŸ’á‰á¶áâ€‹ášá”áŸáŸ‹â€‹á‡á¶áá·â€‹ááŸ’á˜áŸ‚ášáŸ”',
        imageUrl: 'https://placehold.co/600x400/E9967A/333333?text=á€áŸ’ášá˜á¶ááŸ’á˜áŸ‚áš'
    },
    {
        id: 2,
        name: 'ášá¼á”á…á˜áŸ’á›á¶á€áŸ‹á¢á„áŸ’á‚ášáœááŸ’á',
        price: 60000,
        description: 'ášá¼á”á…á˜áŸ’á›á¶á€áŸ‹â€‹á’áŸ’áœá¾â€‹á–á¸â€‹áˆá¾â€‹á˜á¶á“â€‹á€áŸ’á”á¶á…áŸ‹â€‹ášá…á“á¶â€‹á™áŸ‰á¶á„â€‹á›áŸ’á¢á·áá›áŸ’á¢á“áŸ‹â€‹ ášáŸ†á›áŸá…â€‹á–á¸â€‹á‘á·áŠáŸ’á‹á—á¶á–â€‹á”áŸ’ášá¶áŸá¶á‘â€‹á¢á„áŸ’á‚ášáœááŸ’áâ€‹áŠáŸâ€‹á›áŸ’á”á¸á›áŸ’á”á¶á‰áŸ”',
        imageUrl: 'https://placehold.co/600x400/8FBC8F/333333?text=ášá¼á”á…á˜áŸ’á›á¶á€áŸ‹'
    },
    {
        id: 3,
        name: 'áŸá˜áŸ’á›áŸ€á€á”áŸ†á–á¶á€áŸ‹á”áŸ’ášá–áŸƒáá¸ááŸ’á˜áŸ‚áš',
        price: 150000,
        description: 'áˆá»áâ€‹áŸá˜áŸ’á›áŸ€á€â€‹á”áŸ†á–á¶á€áŸ‹â€‹á”áŸ’ášá–áŸƒáá¸â€‹áŸá˜áŸ’ášá¶á”áŸ‹â€‹á…á¼á›ášá½á˜â€‹á€áŸ’á“á»á„â€‹á€á˜áŸ’á˜áœá·á’á¸â€‹á”á»ááŸ’á™â€‹á‘á¶á“â€‹á•áŸ’áŸáŸá„áŸ—áŸ” á˜á¶á“â€‹á…áŸ’ášá¾á“â€‹á–ááŸŒâ€‹áŸá˜áŸ’ášá¶á”áŸ‹â€‹á‡áŸ’ášá¾áŸášá¾áŸáŸ”',
        imageUrl: 'https://placehold.co/600x400/4682B4/FFFFFF?text=áŸá˜áŸ’á›áŸ€á€á”áŸ†á–á¶á€áŸ‹'
    },
    {
        id: 4,
        name: 'á˜áŸ’ášáŸá…á€áŸ†á–á (á”áŸ’ášá—áŸá‘ááŸ’á˜áŸ…)',
        price: 45000,
        description: 'á˜áŸ’ášáŸá…â€‹á€áŸ†á–áâ€‹à¹à¸—à¹‰â€‹á˜á¶á“â€‹ášáŸá‡á¶áá·â€‹áˆáŸ’á„á»á™â€‹á†áŸ’á„á¶á‰áŸ‹â€‹ á“á·á„â€‹á€áŸ’á›á·á“â€‹á€áŸ’ášá¢á¼á”â€‹ Ù…Ù…ÙŠØ²Ø©áŸ” á”á¶á“â€‹á‘á‘á½á›â€‹áŸáŸ’á‚á¶á›áŸ‹â€‹á‡á¶â€‹á•á›á·áá•á›â€‹áŸá˜áŸ’á‚á¶á›áŸ‹â€‹á—á¼á˜á·áŸá¶áŸáŸ’ááŸ’áš (GI)áŸ”',
        imageUrl: 'https://placehold.co/600x400/333333/FFFFFF?text=á˜áŸ’ášáŸá…á€áŸ†á–á'
    }
];

// Function áŸá˜áŸ’ášá¶á”áŸ‹á’áŸ’áœá¾á‘áŸ’ášá„áŸ‹á‘áŸ’ášá¶á™áá˜áŸ’á›áŸƒ (Price Formatting Function)
function formatCurrency(price) {
    return new Intl.NumberFormat('km-KH', { style: 'currency', currency: 'KHR' }).format(price);
}

// 3. á•áŸ’á“áŸ‚á€ HTML Template (HTML Template Section)
function renderPage(title, content) {
    return `
        <!DOCTYPE html>
        <html lang="km">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>${title} | á á¶á„á‘áŸ†á“á·á‰ááŸ’á˜áŸ‚áš</title>
            <link rel="preconnect" href="https://fonts.googleapis.com">
            <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
            <link href="https://fonts.googleapis.com/css2?family=Battambang:wght@400;700&family=Koulen&display=swap" rel="stylesheet">
            <style>
                :root {
                    --primary-color: #9B2226; /* Khmer Red */
                    --secondary-color: #EE9B00; /* Gold */
                    --text-color: #333;
                    --bg-color: #FAF9F6;
                    --card-bg: #FFFFFF;
                }

                body {
                    font-family: 'Battambang', cursive;
                    margin: 0;
                    padding: 0;
                    background-color: var(--bg-color);
                    color: var(--text-color);
                    line-height: 1.6;
                }

                .container {
                    max-width: 1200px;
                    margin: 0 auto;
                    padding: 20px;
                }

                header {
                    background-color: var(--primary-color);
                    color: white;
                    padding: 1rem 0;
                    text-align: center;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                }

                header h1 {
                    font-family: 'Koulen', cursive;
                    margin: 0;
                    font-size: 2.5rem;
                }
                
                header h1 a {
                    color: white;
                    text-decoration: none;
                }

                main { padding: 2rem 0; }
                
                .page-title {
                    text-align: center;
                    font-family: 'Koulen', cursive;
                    font-size: 2.2rem;
                    color: var(--primary-color);
                    margin-bottom: 2rem;
                }

                .product-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                    gap: 25px;
                }

                .product-card {
                    background-color: var(--card-bg);
                    border-radius: 12px;
                    box-shadow: 0 4px 8px rgba(0,0,0,0.08);
                    overflow: hidden;
                    transition: transform 0.3s ease, box-shadow 0.3s ease;
                    display: flex;
                    flex-direction: column;
                }
                
                .product-card:hover {
                    transform: translateY(-5px);
                    box-shadow: 0 8px 16px rgba(0,0,0,0.12);
                }

                .product-card img {
                    width: 100%;
                    height: 200px;
                    object-fit: cover;
                }

                .product-card-content {
                    padding: 20px;
                    flex-grow: 1;
                    display: flex;
                    flex-direction: column;
                }

                .product-card h3 {
                    margin-top: 0;
                    font-family: 'Koulen', cursive;
                    color: var(--primary-color);
                }
                
                .product-card .price {
                    font-weight: bold;
                    color: #007F5F;
                    font-size: 1.2rem;
                    margin-top: auto;
                    margin-bottom: 1rem;
                }

                .product-card .btn {
                    display: block;
                    width: 100%;
                    padding: 10px;
                    background-color: var(--secondary-color);
                    color: var(--text-color);
                    text-align: center;
                    text-decoration: none;
                    border-radius: 8px;
                    font-weight: bold;
                    transition: background-color 0.3s ease;
                }

                .product-card .btn:hover {
                    background-color: #ca6702;
                    color: white;
                }

                .product-detail, .checkout-form {
                    display: flex;
                    flex-wrap: wrap;
                    gap: 40px;
                    background: var(--card-bg);
                    padding: 30px;
                    border-radius: 12px;
                    box-shadow: 0 4px 8px rgba(0,0,0,0.08);
                }
                .product-detail-image { flex: 1 1 400px; }
                .product-detail-image img {
                    width: 100%;
                    border-radius: 12px;
                }
                .product-detail-info { flex: 1 1 400px; }
                .product-detail-info h2 {
                     font-family: 'Koulen', cursive;
                     font-size: 2.5rem;
                     margin-top: 0;
                     color: var(--primary-color);
                }
                .product-detail-info .price {
                    font-size: 2rem;
                    font-weight: bold;
                    color: #007F5F;
                    margin-bottom: 1.5rem;
                }
                .product-detail-info .description {
                    font-size: 1.1rem;
                    margin-bottom: 2rem;
                }
                .btn-action {
                    display: inline-block;
                    background: var(--primary-color);
                    color: white;
                    padding: 15px 30px;
                    font-size: 1.2rem;
                    border-radius: 8px;
                    text-decoration: none;
                    font-weight: bold;
                    transition: background-color 0.3s ease;
                    border: none;
                    cursor: pointer;
                }
                .btn-action:hover { background: #6A040F; }
                .back-link {
                    display: block;
                    margin-top: 2rem;
                    margin-bottom: 1rem;
                    text-decoration: none;
                    color: var(--primary-color);
                    font-weight: bold;
                }
                .back-link:hover { text-decoration: underline; }

                .form-group {
                    width: 100%;
                    margin-bottom: 1.5rem;
                }
                .form-group label {
                    display: block;
                    font-weight: bold;
                    margin-bottom: 0.5rem;
                }
                .form-group input[type="file"] {
                    padding: 10px;
                    border: 1px solid #ccc;
                    border-radius: 8px;
                    width: 100%;
                }

                footer {
                    text-align: center;
                    padding: 20px;
                    margin-top: 40px;
                    background-color: #f2f2f2;
                    border-top: 1px solid #ddd;
                }
            </style>
        </head>
        <body>
            <header>
                <h1><a href="/">á á¶á„á‘áŸ†á“á·á‰ááŸ’á˜áŸ‚áš</a></h1>
            </header>
            <main>
                <div class="container">
                    ${content}
                </div>
            </main>
            <footer>
                <p>&copy; ášá€áŸ’áŸá¶áŸá·á‘áŸ’á’á·á‚áŸ’ášá”áŸ‹á™áŸ‰á¶á„ áŸ¢áŸ áŸ¢áŸ¥ à¹‚à¸”à¸¢ á á¶á„á‘áŸ†á“á·á‰ááŸ’á˜áŸ‚áš</p>
            </footer>
        </body>
        </html>
    `;
}


// 4. Routes (á€á¶ášá€áŸ†áááŸ‹á•áŸ’á›á¼áœ)

// á‘áŸ†á–áŸášáŠá¾á˜ - á”á„áŸ’á á¶á‰á•á›á·áá•á›á‘á¶áŸ†á„á¢áŸáŸ‹
app.get('/', (req, res) => {
    let productGridHtml = `
        <h2 class="page-title">á•á›á·áá•á›ášá”áŸáŸ‹á™á¾á„</h2>
        <div class="product-grid">
    `;
    products.forEach(product => {
        productGridHtml += `
            <div class="product-card">
                <img src="${product.imageUrl}" alt="${product.name}">
                <div class="product-card-content">
                    <h3>${product.name}</h3>
                    <p class="price">${formatCurrency(product.price)}</p>
                    <a href="/product/${product.id}" class="btn">á˜á¾á›á–áŸááŸŒá˜á¶á“á›á˜áŸ’á¢á·á</a>
                </div>
            </div>
        `;
    });
    productGridHtml += '</div>';
    res.send(renderPage('á‘áŸ†á–áŸášáŠá¾á˜', productGridHtml));
});

// á‘áŸ†á–áŸášá–áŸááŸŒá˜á¶á“á›á˜áŸ’á¢á·áášá”áŸáŸ‹á•á›á·áá•á›
app.get('/product/:id', (req, res) => {
    const productId = parseInt(req.params.id);
    const product = products.find(p => p.id === productId);

    if (product) {
        const productDetailHtml = `
            <a href="/" class="back-link">&larr; ááŸ’ášá¡á”áŸ‹á‘áŸ…á‘áŸ†á–áŸášáŠá¾á˜áœá·á‰</a>
            <div class="product-detail">
                <div class="product-detail-image">
                    <img src="${product.imageUrl}" alt="${product.name}">
                </div>
                <div class="product-detail-info">
                    <h2>${product.name}</h2>
                    <p class="price">${formatCurrency(product.price)}</p>
                    <p class="description">${product.description}</p>
                    <a href="/checkout/${product.id}" class="btn-action">à¸ªà¸±à¹ˆà¸‡à¸‹à¸·à¹‰à¸­à¹à¸¥à¸°à¸Šà¸³à¸£à¸°à¹€à¸‡à¸´à¸™</a>
                </div>
            </div>
        `;
        res.send(renderPage(product.name, productDetailHtml));
    } else {
        res.redirect('/');
    }
});

// (GET) á‘áŸ†á–áŸáš Checkout
app.get('/checkout/:id', (req, res) => {
    const productId = parseInt(req.params.id);
    const product = products.find(p => p.id === productId);

    if (product) {
        const checkoutHtml = `
            <a href="/product/${product.id}" class="back-link">&larr; ááŸ’ášá¡á”áŸ‹á‘áŸ…áœá·á‰</a>
            <h2 class="page-title">á”á‰áŸ’á‡á¶á€áŸ‹á€á¶ášá”á‰áŸ’á‡á¶á‘á·á‰ á“á·á„á‘á¼á‘á¶ááŸ‹á”áŸ’ášá¶á€áŸ‹</h2>
            <form class="checkout-form" action="/submit-payment/${product.id}" method="POST" enctype="multipart/form-data">
                <div class="product-detail-info">
                    <h2>${product.name}</h2>
                    <p class="price">áŸášá»á”: ${formatCurrency(product.price)}</p>
                    <div class="form-group">
                        <label for="paymentImage">ğŸ“¸ á”á„áŸ’á áŸ„áŸ‡ášá¼á”á—á¶á–áœá·á€áŸ’á€á™á”ááŸ’ášá‘á¼á‘á¶ááŸ‹á”áŸ’ášá¶á€áŸ‹</label>
                        <input type="file" id="paymentImage" name="paymentImage" accept="image/*" required>
                    </div>
                    <button type="submit" class="btn-action">à¸¢à¸·à¸™à¸¢à¸±à¸™à¸à¸²à¸£à¸Šà¸³à¸£à¸°à¹€à¸‡à¸´à¸™</button>
                </div>
                <div class="product-detail-image">
                    <img src="${product.imageUrl}" alt="${product.name}">
                </div>
            </form>
        `;
        res.send(renderPage(`á‘á¼á‘á¶ááŸ‹á”áŸ’ášá¶á€áŸ‹áŸá˜áŸ’ášá¶á”áŸ‹ ${product.name}`, checkoutHtml));
    } else {
        res.redirect('/');
    }
});

// (POST) Route áŸá˜áŸ’ášá¶á”áŸ‹á”á‰áŸ’á‡á¼á“á€á¶ášá‘á¼á‘á¶ááŸ‹ á“á·á„á•áŸ’á‰á¾á‘áŸ… Discord
app.post('/submit-payment/:id', upload.single('paymentImage'), async (req, res) => {
    if (DISCORD_WEBHOOK_URL === 'YOUR_DISCORD_WEBHOOK_URL_HERE') {
        const errorHtml = `<h2 class="page-title">á€á¶ášá€áŸ†áááŸ‹á˜á·á“ááŸ’ášá¹á˜ááŸ’ášá¼áœ</h2><p style="text-align: center; color: red; font-weight: bold;">áŸá¼á˜á˜áŸááŸ’áá¶á€áŸ†áááŸ‹à¸„à¹ˆà¸² DISCORD_WEBHOOK_URL á“áŸ…á€áŸ’á“á»á„á¯á€áŸá¶áš khmer_shop.js á‡á¶á˜á»á“áŸá·á“áŸ”</p><p style="text-align: center;"><a href="/" class="back-link">ááŸ’ášá¡á”áŸ‹á‘áŸ…á‘áŸ†á–áŸášáŠá¾á˜áœá·á‰</a></p>`;
        return res.status(500).send(renderPage('á˜á¶á“á”á‰áŸ’á á¶', errorHtml));
    }

    const productId = parseInt(req.params.id);
    const product = products.find(p => p.id === productId);

    if (!product) return res.redirect('/');
    if (!req.file) {
        const errorHtml = `<h2 class="page-title">á˜á¶á“á”á‰áŸ’á á¶</h2><p style="text-align: center;">áŸá¼á˜á˜áŸááŸ’áá¶á”á„áŸ’á áŸ„áŸ‡ášá¼á”á—á¶á–áœá·á€áŸ’á€á™á”ááŸ’ášá‘á¼á‘á¶ááŸ‹á”áŸ’ášá¶á€áŸ‹ášá”áŸáŸ‹á¢áŸ’á“á€áŸ”</p><p style="text-align: center;"><a href="/checkout/${product.id}" class="back-link">ááŸ’ášá¡á”áŸ‹á‘áŸ…áœá·á‰</a></p>`;
        return res.status(400).send(renderPage('á˜á¶á“á”á‰áŸ’á á¶', errorHtml));
    }

    const { originalname, size } = req.file;
    const discordPayload = {
        username: "á á¶á„á‘áŸ†á“á·á‰ááŸ’á˜áŸ‚áš (Bot)",
        avatar_url: "https://placehold.co/128x128/9B2226/FFFFFF?text=á á¶á„",
        embeds: [{
            title: "ğŸ’¸ á€á¶ášá‘á¼á‘á¶ááŸ‹á”áŸ’ášá¶á€áŸ‹ááŸ’á˜á¸!",
            color: 5763719,
            timestamp: new Date().toISOString(),
            thumbnail: { url: product.imageUrl },
            fields: [
                { name: "âœ… á•á›á·áá•á›", value: `**${product.name}**`, inline: true },
                { name: "ğŸ’° áá˜áŸ’á›áŸƒ", value: `**${formatCurrency(product.price)}**`, inline: true },
                { name: "ğŸ“„ áœá·á€áŸ’á€á™á”ááŸ’áš", value: `**${originalname}** (${(size / 1024).toFixed(2)} KB)`, inline: false },
            ],
            footer: { text: `á›áŸááŸá˜áŸ’á‚á¶á›áŸ‹á•á›á·áá•á›: ${product.id}` },
        }],
    };

    try {
        await axios.post(DISCORD_WEBHOOK_URL, discordPayload);
        const successHtml = `<h2 class="page-title">à¸‚à¸­à¸šà¸„à¸¸à¸“!</h2><p style="text-align: center;">á™á¾á„á”á¶á“á‘á‘á½á›á€á¶ášá”á‰áŸ’á‡á¶á‘á·á‰ášá”áŸáŸ‹á¢áŸ’á“á€áŸá˜áŸ’ášá¶á”áŸ‹ **${product.name}** á á¾á™áŸ”</p><p style="text-align: center;">á™á¾á„á“á¹á„á–á·á“á·ááŸ’á™á˜á¾á›á€á¶ášá‘á¼á‘á¶ááŸ‹á”áŸ’ášá¶á€áŸ‹ášá”áŸáŸ‹á›áŸ„á€á¢áŸ’á“á€ á“á·á„á‘á¶á€áŸ‹á‘á„à¸à¸¥à¸±à¸šà¹„à¸›á€áŸ’á“á»á„á–áŸá›á†á¶á”áŸ‹áŸ—à¸™à¸µà¹‰áŸ”</p><p style="text-align: center;"><a href="/" class="back-link">ááŸ’ášá¡á”áŸ‹á‘áŸ…á‘áŸ†á–áŸášáŠá¾á˜</a></p>`;
        res.send(renderPage('á€á¶ášá”á‰áŸ’á‡á¶á‘á·á‰à¸ªà¸³à¹€à¸£à¹‡à¸ˆ', successHtml));
    } catch (error) {
        console.error('á˜á¶á“á”á‰áŸ’á á¶á€áŸ’á“á»á„á€á¶ášá•áŸ’á‰á¾á€á¶ášá‡á¼á“áŠáŸ†áá¹á„á‘áŸ… Discord:', error.message);
        const errorHtml = `<h2 class="page-title">á˜á¶á“á”á‰áŸ’á á¶</h2><p style="text-align: center;">á˜á¶á“á”á‰áŸ’á á¶á€áŸ’á“á»á„á€á¶ášá”á‰áŸ’á‡á¼á“á€á¶ášá”á‰áŸ’á‡á¶á‘á·á‰ášá”áŸáŸ‹á›áŸ„á€á¢áŸ’á“á€áŸ” áŸá¼á˜á–áŸ’á™á¶á™á¶á˜á˜áŸ’áá„á‘áŸ€ááŸ”</p><p style="text-align: center;"><a href="/checkout/${product.id}" class="back-link">ááŸ’ášá¡á”áŸ‹á‘áŸ…áœá·á‰</a></p>`;
        res.status(500).send(renderPage('á˜á¶á“á”á‰áŸ’á á¶', errorHtml));
    }
});


// 5. á€á¶ášá…á¶á”áŸ‹á•áŸ’áŠá¾á˜á˜áŸ‰á¶áŸáŸŠá¸á“á˜áŸ (Start the Server)
app.listen(port, () => {
    console.log(`á˜áŸ‰á¶áŸáŸŠá¸á“á˜áŸ (Server) á€áŸ†á–á»á„áŠáŸ†áá¾ášá€á¶ášá“áŸ…á›á¾ http://localhost:${port}`);
});

